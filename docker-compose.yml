services:
  # 1. Database Utama
  postgres:
    image: postgres:15-alpine
    container_name: teluhub_db
    restart: always
    env_file:
      - ./.env
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 2. Backend (Go Fiber)
  backend:
    build:
      context: ./backend
      dockerfile: DockerFile
    container_name: teluhub_backend
    restart: always
    ports:
      - "8910:8910"    # Fiber API
      - "50051:50051"  # gRPC internal
      - "8081:8081"    # gRPC-Web proxy
    env_file:
      - ./.env
    environment:
      # FIX PALING PENTING
      APP_PORT: ":8910"

      # DB config
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}

      # Auth + Midtrans
      JWT_SECRET: ${JWT_SECRET}
      MIDTRANS_SERVER_KEY: ${MIDTRANS_SERVER_KEY}
      MIDTRANS_CLIENT_KEY: ${MIDTRANS_CLIENT_KEY}

      # Domain frontend & backend
      CLIENT_URL: ${CLIENT_URL}
      SERVER_URL: ${SERVER_URL}

    depends_on:
      - postgres
    volumes:
      - ./backend/uploads:/root/uploads

  # 3. Frontend (Next.js) â€” optional
  frontend:
    env_file:
      - ./.env
    build:
      context: ./frontend
      dockerfile: DockerFile
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
        NEXT_PUBLIC_MIDTRANS_CLIENT_KEY: ${NEXT_PUBLIC_MIDTRANS_CLIENT_KEY}
    container_name: teluhub_frontend
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - backend

volumes:
  postgres_data:
